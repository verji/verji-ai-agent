# Dockerfile.dev for verji-vagent-graph
# Development image with hot reload support

FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN pip install --no-cache-dir poetry

# Copy dependency files
COPY pyproject.toml poetry.lock* ./

# Install dependencies (no root package yet for layer caching)
RUN poetry config virtualenvs.create false && \
    poetry install --no-root --no-interaction --no-ansi

# Install grpc health probe
RUN wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/v0.4.19/grpc_health_probe-linux-amd64 && \
    chmod +x /bin/grpc_health_probe

# Copy source code (will be overridden by Tilt live_update)
COPY src/ ./src/

# Install the package in development mode
RUN poetry install --no-interaction --no-ansi

# Expose gRPC port
EXPOSE 50051

# Use watchfiles for hot reload
# This watches src/ directory and auto-reloads on changes
CMD ["watchfiles", "--ignore-paths", "**/__pycache__", "src.main.main", "src/"]
